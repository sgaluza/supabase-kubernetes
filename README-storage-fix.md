# Скрипт для исправления Extended Attributes в Supabase Storage

Этот bash-скрипт автоматизирует процесс исправления ошибки "The extended attribute does not exist" в Supabase Storage при использовании файлового бэкенда хранилища.

## Проблема

Как описано в [Issue #201](https://github.com/supabase/storage/issues/201), когда файлы перемещаются или копируются в системе хранения, расширенные атрибуты (extended attributes) не сохраняются. Это вызывает ошибки при попытке доступа к этим файлам позже.

Сообщение об ошибке в логах:
```
{"error":{"raw":"{\"code\":\"ENODATA\",\"errno\":61}","name":"Error","message":"The extended attribute does not exist."}}
```

## Решение

Скрипт `fix-all-files.sh` автоматизирует процесс исправления, выполняя следующие шаги:
1. Получает информацию о файлах из базы данных PostgreSQL (таблица storage.objects)
2. Находит соответствующие файлы в файловой системе
3. Устанавливает необходимые расширенные атрибуты для каждого файла:
   - user.supabase.content-type - тип содержимого файла из поля metadata.mimetype
   - user.supabase.cache-control - параметры кэширования из поля metadata.cacheControl

## Использование

```bash
./fix-all-files.sh <имя_пода> <неймспейс>
```

### Параметры

- `<имя_пода>` (обязательный): Имя пода Supabase Storage
- `<неймспейс>` (обязательный): Kubernetes неймспейс, в котором находится под

### Примеры

```bash
# Пример использования
./fix-all-files.sh supabase-storage-6946c68979-kwcpb bex-supa-staging
```

## Требования

- kubectl, настроенный для доступа к вашему кластеру Kubernetes
- Под Supabase Storage должен использовать Alpine Linux (или другую систему с поддержкой setfattr)

## Как это работает

1. Скрипт проверяет существование указанного пода
2. Создает временный скрипт для выполнения в поде
3. Копирует скрипт в под
4. Запускает скрипт внутри пода, который:
   - Устанавливает PostgreSQL клиент, если его нет
   - Устанавливает пакет attr для работы с расширенными атрибутами, если его нет
   - Подключается к базе данных и получает информацию о файлах из таблицы storage.objects
   - Для каждого файла:
     - Определяет его путь в файловой системе на основе данных из БД
     - Получает MIME-тип и параметры кэширования из поля metadata в БД
     - Устанавливает расширенные атрибуты user.supabase.content-type и user.supabase.cache-control
5. Очищает временные файлы после завершения

## Преимущества обновленного скрипта

1. **Использование данных из БД**: Скрипт получает точную информацию о MIME-типах и параметрах кэширования из базы данных, а не определяет их на основе расширения файла.
2. **Правильное определение путей**: Скрипт учитывает сложную структуру хранилища и правильно определяет пути к файлам.
3. **Автоматическая установка зависимостей**: Скрипт автоматически устанавливает необходимые пакеты (postgresql-client и attr).
4. **Обработка всех типов файлов**: Скрипт обрабатывает все типы файлов, включая файлы без расширения и файлы в подпапках.

## Таблица storage.objects

Таблица `storage.objects` содержит информацию о всех файлах в хранилище. Основные поля:

- `name`: Имя файла (включая путь)
- `bucket_id`: ID корзины (bucket)
- `metadata`: JSON-объект с метаданными, включая:
  - `mimetype`: MIME-тип файла
  - `cacheControl`: Параметры кэширования
  - `size`: Размер файла
  - `lastModified`: Дата последнего изменения

Пример записи:
```json
{
  "name": "01008452b26bee0525.jpg",
  "bucket_id": "avatars",
  "metadata": {
    "mimetype": "image/jpeg",
    "cacheControl": "max-age=3600",
    "size": 4312,
    "lastModified": "2025-03-13T07:16:03.428Z"
  }
}
```

## Структура хранения файлов в Supabase Storage

В процессе исследования проблемы мы выяснили, что Supabase Storage использует следующую структуру хранения файлов:

```
/var/lib/storage/stub/stub/{bucket_name}/{file_path}/{uuid}
```

Где:
- `{bucket_name}` - имя корзины (bucket), например, avatars, logos, portfolio-images и т.д.
- `{file_path}` - путь к файлу внутри корзины, может включать подпапки
- `{uuid}` - уникальный идентификатор файла

Примеры:
```
/var/lib/storage/stub/stub/avatars/01ee372de9f91db64f.jpg/7498b64a-3e1b-497e-8bda-0e5874b8fb1e
/var/lib/storage/stub/stub/portfolio-images/partner-freelancers/1f8d3e04-8913-4e14-8a42-e39d7f32f243.jpg/658eaf83-2577-458f-840f-d6a971faaa12
```

Эта структура позволяет Supabase Storage эффективно организовывать файлы и управлять ими, но требует правильной настройки расширенных атрибутов для корректной работы.

## Долгосрочное решение

Этот скрипт является временным решением. Для долгосрочного решения рекомендуется:

1. Обновить Supabase Storage до более новой версии, где эта проблема уже исправлена
2. При копировании файлов между серверами использовать команды, сохраняющие extended attributes:
   - `rsync -Xavz --fake-super` для Linux
   - `cp -a` для macOS